{
	order authenticate before respond
	order authorize before basicauth

	security {

                oauth identity provider github {{ github_oauth_client_id }} {{ github_oauth_client_secret }}

                authentication portal myportal {
			crypto default token lifetime 3600
			enable identity provider github
                        crypto key sign-verify {env.JWT_SHARED_KEY}
			cookie domain {{ base_auth_domain }}
			ui {
				links {
					"My Identity" "/whoami" icon "las la-user"
				}
			}

			transform user {
				match realm github
                                match sub {{ github_allow_list }}
				action add role authp/admin
			}
		}

		authorization policy mypolicy {
			set auth url https://{{ base_auth_domain }}/auth/oauth2/github
			crypto key sign-verify {env.JWT_SHARED_KEY}
                        allow roles authp/admin
			validate bearer header
			inject headers with claims
		}
	}
}

{% for project, cfg in projects.items() %}
https://{{ cfg.domain }} {

    log {
        output file /var/log/caddy/{{cfg.log_file}}.log {
            roll_size 10MiB
            roll_keep 10
            roll_keep_for 24h
        }
    }
	
    {% for path in cfg.paths %}
    handle {{ path }} {
        reverse_proxy {{ cfg.backend }}
    }
    {% endfor %}

    {% if cfg.secure %}
    handle /auth* {
        authenticate with myportal
    }	
    {% endif %}

    handle {
        {% if cfg.secure %}
        authorize with mypolicy
        {% endif %}
        reverse_proxy {{ cfg.frontend }}
    }
}
{% endfor %}
